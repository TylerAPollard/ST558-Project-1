---
title: "ST558 Project 1"
author: "Tyler Pollard"
date: "6/15/2021"
output: 
  github_document:
    toc: TRUE
    toc_depth: 3
---

```{r setup, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE)
#github_document(toc = TRUE, toc_depth = 3)
```

# Reading and Summarizing Data from the National Hockey League's (NHL) API

## Introduction
This vignette is an introduction on how to read and summarize data using the `tidyverse`. We will be using the National Hockey League's (NHL) API. 

## Load Packages
Before reading and summarizing the data, some necessary packages must be loaded.
```{r packages, echo = TRUE}
library(httr)
library(jsonlite)
library(rmarkdown)
library(knitr)
library(tidyverse)
library(dplyr)
library(readr)
library(DT)
library(lubridate)
library(ggplot2)
```

## NHL Record API
```{r API reader}
API_info <- function(call){
  base <- "https://records.nhl.com/site/api"
  get_info <- GET(paste0(base, "/", call))
  get_info_text <- content(get_info, as = "text")
  get_info_json <- fromJSON(get_info_text, flatten = TRUE)
  get_info_df <- as.data.frame(get_info_json)
  get_info_tbl <- tbl_df(get_info_df)
  return(get_info_tbl)
}
```


### Franchise
```{r NHL Record API franchise}
franchise_info <- function(){
  franchise_df <- API_info("franchise")
  franchise_df <- franchise_df %>% select(data.id, data.mostRecentTeamId, data.fullName, data.teamPlaceName,
                                                  data.teamCommonName, data.teamAbbrev, data.firstSeasonId,
                                                  data.lastSeasonId, total) %>% arrange(data.mostRecentTeamId)
  return(franchise_df)
}
```

### Franchise Team Totals
```{r NHL Record API franchise team totals}
franchise_team_totals <- function(){
  team_df <- API_info("franchise-team-totals")
  team_df$data.activeFranchise <- as_factor(team_df$data.activeFranchise)
  levels(team_df$data.activeFranchise) <- list("No" = 0, "Yes" = 1)
  team_df$data.gameTypeId <- as_factor(team_df$data.gameTypeId)
  levels(team_df$data.gameTypeId) <- list("Regular Season" = 2, "Playoffs" = 3)
  team_df <- team_df %>% select(data.id, data.franchiseId, data.teamName, data.triCode, data.teamId, data.activeFranchise, data.firstSeasonId, data.lastSeasonId, everything()) %>% arrange(data.franchiseId)
  return(team_df)
  # col_names <- c("Franchise ID", "Team Name", "Abbreviation", "Team ID", "Active Franchise", "First Season", "Last Season", "Game Type", "Games Played", "Goals Against", "Goals For", "Home Losses", "Home Overtime Losses", "Home Ties","Home Wins", "Losses", "Overtime Losses", "Penalty Minutes", "Point Percentage", "Data Points", "Road Losses", "Road Overtime Losses", "Road Ties", "Road Wins", "Shootout Losses", "Shootout Wins","Shutouts", "Ties", "Wins")
}
```

```{r franchise to ID, error=TRUE, message = TRUE}
franchise_ID <- function(franchise){
  if(is.numeric(franchise)){
    if(franchise >0 & franchise < 39)
      return(franchise)
    else{
      stop("Please enter a valid franchise ID from 1-38")
    }
  }else{
    ID_df <- API_info("franchise-team-totals")
    if(franchise %in% ID_df$data.teamName){
      ID_num <- ID_df %>% select(data.teamName, data.franchiseId) %>% filter(data.teamName == franchise) %>% select(data.franchiseId) %>% filter(row_number() == 1)
      return(ID_num[[1]][1])
    }else{
      stop("Please enter a valid franchise name")
    }
  }
}
```

```{r Team ID, error = TRUE}
team_ID <- function(franchise){
  if(is.numeric(franchise)){
    if(franchise > 0 & franchise < 56){
      if(franchise %in% c(11,27,31,32,33,34,35,36,38,40,42,44,46,47,48,50)){
        stop("No team ID for 11, 27, 31, 32, 33, 34, 35, 36, 38, 40, 42, 44, 46, 47, 48, 50")
      }else{
        return(franchise)
      }
    }else{
      stop("Please enter a valid team ID from 1-55")
    }
  }else{
    ID_df <- API_info("franchise")
    if(franchise %in% ID_df$data.fullName){
      ID_num <- ID_df %>% select(data.fullName, data.mostRecentTeamId) %>% filter(data.fullName == franchise) %>% select(data.mostRecentTeamId) %>% filter(row_number() == 1)
      return(ID_num[[1]][1])
    }else{
      stop("Please enter a valid franchise name")
    }
  }
}
```

### Season Records
```{r NHL Franchise Season Records, error = TRUE}
season_record <- function(franchise){
  season_df <- API_info(paste0("franchise-season-records?cayenneExp=franchiseId=", franchise_ID(franchise)))
  season_df <- season_df %>% select(data.id, data.franchiseName, data.franchiseId, everything())
  return(season_df)
}
```

### Goalie Records
```{r Goalie Records, error = TRUE}
goalie_record <- function(franchise){
  goalie_df <- API_info(paste0("franchise-goalie-records?cayenneExp=franchiseId=", franchise_ID(franchise)))
  return(goalie_df)
}
```

### Skater Records
```{r Skater Records, error = TRUE}
skater_record <- function(franchise){
  skater_df <- API_info(paste0("franchise-skater-records?cayenneExp=franchiseId=", franchise_ID(franchise)))
  return(skater_df)
}
```

### Admin History and Retired Numbers
```{r Admin History and Retired Numbers, error = TRUE}
admin_history <- function(franchise){
  admin_history_df <- API_info(paste0("franchise-detail?cayenneExp=mostRecentTeamId=", team_ID(franchise)))
  admin_history_df <- admin_history_df %>% select(data.mostRecentTeamId, data.teamFullName, data.teamAbbrev, data.id, everything())
  return(admin_history_df)
}
```

## NHL Stats API
```{r NHL Stats API}
team_stats <- function(franchise = NULL){
  base <- "https://statsapi.web.nhl.com/api/v1/teams"
  if(is.null(franchise)){
    url <- paste0(base, "?expand=team.stats")
  }else{
    ID <- team_ID(franchise)
    url <- paste0(base, "/", ID, "?expand=team.stats")
  }
  get_stats <- GET(url)
  get_stats_text <- content(get_stats, as = "text")
  get_stats_json <- fromJSON(get_stats_text, flatten = TRUE)
  get_stats_df <- as.data.frame(get_stats_json)
  get_stats_tbl <- tbl_df(get_stats_df)
  return(get_stats_tbl)
}
```

```{r Stats One Stop}
stats_one <- function(endpoint, franchise = NULL, modifier = NULL){
  base <- "https://statsapi.web.nhl.com/api/v1/"
  if(is.null(endpoint)){
    stop("Please enter endpoint")
  }else{
    if(is.null(franchise) & is.null(modifier)){
      url <- paste0(base, endpoint)
      return(url)
    }else if(!is.null(franchise) & is.null(modifier)){
      ID <- team_ID(franchise)
      url <- paste0(base, endpoint, "/", ID)
      return(url)
    }else if(is.null(franchise) & !is.null(modifier)){
      url <- paste0(base, endpoint, modifier)
      return(url)
    }else{
      ID <- team_ID(franchise)
      url <- paste0(base, endpoint, "/", ID, modifier)
      return(url)
    }
  }
}
```

```{r Wrapper function}
NHL_info <- function(endpoint, franchsie = NULL, modifier = NULL){
  
}
```

### Boxplot of Divsions
```{r division barplot}
team_stats_df_1 <- team_stats()
team_stats_df <- team_stats_df_1 %>% select(teams.name, teams.division.name, teams.teamStats)
unique(team_stats_df$teams.division.name, na.rm =TRUE)
points <- c()
for(i in 1:nrow(team_stats_df)){
  points <- c(points, ((team_stats_df[[3]][[i]])[[1]][[1]])$stat.pts[1])
}
team_stats_df <- team_stats_df[-32,]
team_stats_df <- cbind(team_stats_df, points)
team_stats_df <- team_stats_df %>% select(-teams.teamStats)
team_stats_df$teams.division.name <- as_factor(team_stats_df$teams.division.name)
team_stats_df$points <- as.numeric(as.character(team_stats_df$points))
ggplot(data = team_stats_df, aes(x = teams.division.name, y = points)) + geom_boxplot() + geom_point(aes(color = teams.division.name), position = "jitter") + labs(x = "Division", y = "Season Points") + scale_color_discrete(name = "Divisions")
```

